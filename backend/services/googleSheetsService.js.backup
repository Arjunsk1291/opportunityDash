export async function fetchGoogleSheetData(apiKey, spreadsheetId, sheetName) {
  try {
    const range = `${sheetName}!A:Z`;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
    
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
    
    const data = await response.json();
    const rows = data.values || [];
    
    // Find first non-empty row (header row)
    let headerRowIndex = 0;
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i] || [];
      if (row.some(cell => cell && cell.toString().trim())) {
        headerRowIndex = i;
        break;
      }
    }
    
    return {
      headerRowIndex,
      rows: rows.slice(headerRowIndex), // Return from header row onwards
      headers: rows[headerRowIndex] || [],
    };
  } catch (error) {
    throw new Error(`Failed to fetch Google Sheets data: ${error.message}`);
  }
}

export function mapSheetRowToOpportunity(row, mapping) {
  const mapped = {};
  
  Object.entries(mapping).forEach(([key, columnIndex]) => {
    if (columnIndex !== undefined && row[columnIndex]) {
      if (key === 'opportunityValue') {
        mapped[key] = parseFloat(row[columnIndex]) || 0;
      } else {
        mapped[key] = row[columnIndex].toString().trim();
      }
    }
  });
  
  return mapped;
}
